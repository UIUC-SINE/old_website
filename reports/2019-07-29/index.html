<!DOCTYPE html>
<html lang=en>

<head>
  <title>Weekly Report</title>
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" type="text/css" href="/styles.css" /> 
  <link rel="stylesheet" type="text/css" href="/codehilite.css" /> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>



</head>
<body>
<main>
  <article>
    <header>
      <h1>Weekly Report</h1>
      <time datetime="2019-07-29">2019-07-29</time> - Evan Widloski
    </header>
    <p>This week I dove into <a href="https://journals.sagepub.com/doi/full/10.1177/0954410017691315">this paper</a> on attitude estimation by fusing sensor data from the imaging instrument, star tracker and gyro.  It uses the Lukas-Kanade method for registering images, summarized below, then fuses the three motion estimates in an extended Kalman filter.</p>
<p>I also briefly revisited CSBS and engineered a scenario where CSBS finds a measurement configuration that outperforms the naive focus selection method.</p>
<h1 id="lukas-kanade-optical-flow">Lukas-Kanade Optical Flow</h1>
<p>Optical flow is a registration method geared motion estimation in video where one might have multiple objects moving in a scene.  However, it can still be applied to rigid or affine registration of a whole scene.</p>
<p>The fundamental assumption of this method is that a stationary point in the scene will have constant intensity.  i.e.</p>
<p>
<script type="math/tex; mode=display">
\frac{di}{dt}(\bm{x}) + \frac{di}{dx}(\bm{x}) u + \frac{di}{dy}(\bm{x}) v = 0
</script>
</p>
<p>where <script type="math/tex">u</script>, <script type="math/tex">v</script> are the motion vectors.</p>
<p>An implicit assumption here is that <script type="math/tex">i(x, y, t)</script> is a continuous function spatially and temporally, which will be addressed later.</p>
<p>However, the above system is underdetermined because there are two unknowns and only 1 equation.  If we expand the constant intensity assumption to a cluster of points with the same motion vector, the system can be solved.</p>
<p>
<script type="math/tex; mode=display">
\underbrace{
\begin{bmatrix}
\frac{di}{dx}(\bm{x}_1) & \frac{di}{dy}(\bm{x}_1) \\
\frac{di}{dx}(\bm{x}_2) & \frac{di}{dy}(\bm{x}_2) \\
\vdots & \vdots \\
\end{bmatrix}
}_{A}
\underbrace{
\begin{bmatrix}
u \\ v
\end{bmatrix}
}_{\bm{v}}
=
\underbrace{
\begin{bmatrix}
- \frac{di}{dt}(\bm{x}_1) \\
- \frac{di}{dt}(\bm{x}_2) \\
\vdots
\end{bmatrix}
}_{\bm{b}}
</script>
</p>
<p>Which is overdetermined and can now be solved with least-squares:</p>
<p>
<script type="math/tex; mode=display">
\begin{aligned}
\bm{v} &= (A^TA)^{-1} A \bm{b} \\
&= \begin{bmatrix}\sum_{\bm{x}} \frac{di}{dx}(\bm{x})^2 & \sum_{\bm{x}} \frac{di}{dx}(\bm{x}) \frac{di}{dy}(\bm{x}) \\
\sum_{\bm{x}} \frac{di}{dx}(\bm{x}) \frac{di}{dy}(\bm{x}) & \sum_{\bm{x}} \frac{di}{dx}(\bm{x})^2 \end{bmatrix}^{-1}
\begin{bmatrix}
\sum_{\bm{x}} \frac{di}{dt}(\bm{x}) \frac{di}{dx}(\bm{x}) \\
\sum_{\bm{x}} \frac{di}{dt}(\bm{x}) \frac{di}{dy}(\bm{x})
\end{bmatrix}
\end{aligned}
</script>
</p>
<p>We can arrive at this derivation another way, which will help with generalization later.</p>
<p>Define <script type="math/tex">E(u, v) = \sum \left[ i_2(x + u, y + v) - i_1(x, y) \right]^2</script> as the squared error between <script type="math/tex">i_1</script> and registered <script type="math/tex">i_2</script>.  With a first order Taylor expansion, we can write</p>
<p>
<script type="math/tex; mode=display">
\begin{aligned}
E(u, v) &= \sum \left[ i_2(x + u, y + v) - i_1(x, y) \right]^2 \\
&\approx \sum \left[ i_2(x, y) + u i_{1x}(x, y) + v i_{2x}(x, y) - i_2(x, y) \right]^2 \\
&= \sum \left[ u i_{1x}(x, y) + v i_{1y}(x, y) + D(x, y)\right]
\end{aligned}
</script>
</p>
<p>where <script type="math/tex">i_{1x}</script> and <script type="math/tex">i_{1y}</script> are the discrete derivatives of <script type="math/tex">i_1</script> in the <script type="math/tex">x</script> and <script type="math/tex">y</script> directions and <script type="math/tex">D</script> is the difference between <script type="math/tex">i_1</script> and <script type="math/tex">i_2</script>.</p>
<p>Taking the partial derivatives of the squared error in the x and y directions and setting to zero,</p>
<p>
<script type="math/tex; mode=display">
\begin{aligned}
\frac{dE}{du} &= \sum \left[ u i_{1x}(x, y) + v i_{1y}(x, y) + D(x, y)\right] i_{1x}(x, y) = 0 \\
\frac{dE}{dv} &= \sum \left[ u i_{1x}(x, y) + v i_{1y}(x, y) + D(x, y)\right] i_{1y}(x, y) = 0
\end{aligned}
</script>
</p>
<p>which when collected into a matrix gives</p>
<p>
<script type="math/tex; mode=display">
\begin{bmatrix}u \\ v\end{bmatrix} = 
\begin{bmatrix}
\sum_{\bm{x}} i_{1x}(\bm{x})^2 & \sum_{\bm{x}} i_{1x}(\bm{x})i_{1y}(\bm{x}) \\
\sum_{\bm{x}} i_{1x}(\bm{x})i_{1y}(\bm{x}) & \sum_{\bm{x}} i_{1x}(\bm{x})^2
\end{bmatrix}
\begin{bmatrix}
\sum_{\bm{x}} D(\bm{x}) i_{1x}(\bm{x}) \\
\sum_{\bm{x}} D(\bm{x}) i_{1y}(\bm{x}) \\
\end{bmatrix}
</script>
</p>
<p>which is the same solution as previously given but for discrete <script type="math/tex">i_1</script> and <script type="math/tex">i_2</script>.</p>
<h1 id="revisiting-csbs">Revisiting CSBS</h1>
<p>In a <a href="https://uiuc-sine.github.io/reports/csbs_4modes/index.html">previous report</a>, I numerically demonstrated that under our typical simulation assumptions of 33.4 and 33.5nm sources, CSBS plane selection will at best yield a reconstruction quality that is equal to naive plane selection (measuring at focal planes only).  However, at the end of the report I hypothesized that there is a scenario where CSBS might outperforms the naive method.  This scenario, which I call 'failure of the separation condition', occurs when spectral lines from two sources are very close and the out of focus contributions from either source are fairly sharp.</p>
<p>I tested out this idea with an extreme scenario with two sources at 33.4 and 33.402nm and only 0.02nm of separation, comparing the Tikhonov reconstruction quality of naive plane selection vs CSBS under 30dB SNR Gaussian noise.</p>
<p>
<figure><img src="recon_focus.png" /><figcaption>Source reconstruction using naive plane selection.</figcaption>
</figure>
</p>
<p>
<figure><img src="recon_csbs.png" /><figcaption>Source reconstruction using CSBS selection</figcaption>
</figure>
</p>
<table>
<thead>
<tr>
<th></th>
<th>Source 1 SSIM</th>
<th>Source 2 SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td>Naive</td>
<td>0.651</td>
<td>0.615</td>
</tr>
<tr>
<td>CSBS</td>
<td>0.937</td>
<td>0.937</td>
</tr>
</tbody>
</table>
<p>Previously where reconstruction with CSBS did slightly worse than the naive selection case, CSBS now significantly outperform naive plane selection.  0.02nm of separation between sources is unrealistic, but these tests show that there are at least some situations where CSBS does better.</p>
<p>An interesting note is that CSBS tended to choose measurement locations outside the two focal planes, rather than between them as we had predicted for a long time.  Originally I thought that making measurements where PSF pairs capture a lot of energy from both sources would be best because of high measurement SNR.  However, PSF pairs in this region are very coherent and so it becomes harder to separate the sources.  Instead CSBS opted for measurement locations where one source was in focus and the other out of focus.</p>
<p>
<figure><img src="fourier_slices.png" /><figcaption>CSBS plane selection result for two narrowly separated lines.  CSBS tended to choose measurement locations where only one source was in focus, rather than both.</figcaption>
</figure>
</p>
  </article>
</main>
<footer>
    <p>SINE UIUC</p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/mathtex-script-type.min.js"></script> 
</body>
</html>