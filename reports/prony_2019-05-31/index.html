<!DOCTYPE html>
<html lang=en>

<head>
  <title>Spectral estimation applied to Phase correlation</title>
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" type="text/css" href="/styles.css" /> 
  <link rel="stylesheet" type="text/css" href="/codehilite.css" /> 
<script type="text/javascript"
   src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</head>
<body>
<main>
  <article>
    <header>
      <h1>Spectral estimation applied to Phase correlation</h1>
      <time datetime="2019-06-09">2019-06-09</time> - Evan Widloski
    </header>
    <div class="toc">
<ul>
<li><a href="#investigated-papers">Investigated Papers</a></li>
<li><a href="#paper-review-efficient-subpixel-registration-algorithms">Paper Review - Efficient Subpixel Registration Algorithms</a><ul>
<li><a href="#method-1-conjugate-descent">Method 1 - Conjugate Descent</a></li>
<li><a href="#method-2-single-step-idft">Method 2 - Single Step IDFT</a></li>
<li><a href="#method-3-multi-step-idft">Method 3 - Multi Step IDFT</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#paper-review-extension-of-phase-correlation-to-subpixel-registration">Paper Review - Extension of Phase Correlation to Subpixel Registration</a><ul>
<li><a href="#main-idea">Main Idea</a></li>
<li><a href="#solving-for-the-subpixel-offset">Solving for the subpixel offset</a></li>
<li><a href="#conclusion_1">Conclusion</a></li>
</ul>
</li>
<li><a href="#pronys-method-idea">Prony's Method Idea</a><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#preliminary-tests">Preliminary Tests</a></li>
</ul>
</li>
<li><a href="#other-papers">Other Papers</a></li>
<li><a href="#plans">Plans</a></li>
</ul>
</div>
<p>I want to narrow my focus down, so I spent this week investigating a few subpixel registration methods centered around phase-correlation.  Since these phase-correlation methods are all finding a frequency peak in the cross power spectral density (CPSD) of two images, they are technically all spectral estimation methods.</p>
<p>I also introduce Prony's method and my idea for potentially adapting it to finding the peak of the CPSD at non-integer scales.</p>
<h1 id="investigated-papers">Investigated Papers</h1>
<ul>
<li><a href="https://www.osapublishing.org/ol/viewmedia.cfm?uri=ol-33-2-156&amp;seq=0">Efficient Subpixel Registration Algorithms</a> - Guizar-Sicairos, Thurman, Fienup 2008<ul>
<li>uses standard phase correlation to get whole-pixel estimate, then zero-pad and IDFT to get subpixel estimates</li>
</ul>
</li>
<li><a href="https://ieeexplore.ieee.org/document/988953">Extension of Phase Correlation to Subpixel Registration</a> - Foroosh, Zerubia, Berthod 2002<ul>
<li>assumes measured images are downsampled version of high-resolution grid</li>
<li>observes that non-integer offset results in Dirichlet function around offset freq</li>
</ul>
</li>
</ul>
<h1 id="paper-review-efficient-subpixel-registration-algorithms">Paper Review - Efficient Subpixel Registration Algorithms</h1>
<p>This paper presents 3 subpixel registration methods all based on phase-correlation.  The second of these methods seems to be widely cited because of it's simplicity.</p>
<h4 id="method-1-conjugate-descent">Method 1 - Conjugate Descent</h4>
<p>The first method presented is a form of conjugate descent on the normalized root mean squared error (NRMSE), which is a translation-invariant measure of error between an image <script type="math/tex">f</script> and a copy <script type="math/tex">g</script> shifted by <script type="math/tex">(x_0^{\ast}, y_0^*)</script>.</p>
<p><code>math
NMSRE^2 = \min_{x_0, y_0}\frac{\sum_{x,y} |g(x - x_0, y - y_0) - f(x, y)|^2}{\sum_{x,y}|f(x, y)|^2}</code></p>
<p>By minimizing the NMSRE over <script type="math/tex">(x_0, y_0)</script>, the true offset of <script type="math/tex">g</script> can be found.  This is not mentioned in the paper, but this error formulation implicitly assumes a circular image shift.</p>
<p>Rewriting the above definition into a maximization problem, we can achieve a more useful formulation</p>
<p>```math
NMSRE^2 = 1 - \frac{\max_{x_0, y_0} |r(x_0, y_0)|^2}{\sum_{x, y}|f(x, y)|^2 \sum_{x, y}|g(x, y)|^2} \</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
r(x_0, y_0) &= \sum_{x, y}g(x - x_0, y - y_0)f^*(x, y) \\
&= \sum_{u, v} F(u, v)G^*(u, v) \text{exp}\left[ j 2 \pi \left( u \frac{x_0}{M} + v \frac{y_0}{N} \right) \right]
\end{aligned}</script>
```</p>
<p>where <script type="math/tex">r</script> is cross correlation and <script type="math/tex">F</script> and <script type="math/tex">G</script> are the image DFTs of size <script type="math/tex">M \times N</script>.</p>
<p>Since all other terms are constant, we need only minimize <script type="math/tex">|r(x_0, y_0)|^2</script>.</p>
<p><code>math
\frac{d(r(x_0, y_0))}{dx_0} = 2 \text{Im} \left(r(x_0, y_0) \sum_{u, v} \frac{2 \pi u}{M} F^*(u, v) \times G(u, v) \text{exp} \left[-j 2 \pi \left( u \frac{x_0}{M} + v \frac{y_0}{N} \right) \right] \right)</code></p>
<p>With this partial derivative (and a similar for <script type="math/tex">y_0</script>) we can use standard conjugate descent to solve for <script type="math/tex">(x_0^{\ast}, y_0^*)</script>.</p>
<h4 id="method-2-single-step-idft">Method 2 - Single Step IDFT</h4>
<p>This method is a simple grid-search algorithm which takes advantage of the fact that zero-padding before DFT or IDFT samples the function more finely in the transform domain.</p>
<p>The first step of the algorithm is to obtain a coarse estimate for the shift by applying IFFT to the CPSD and finding the maximum.  Next, <script type="math/tex">f</script> and <script type="math/tex">g</script> are zero-padded by a factor of <script type="math/tex">\kappa</script>, CPSD recomputed, and IDFT computed for some select values of <script type="math/tex">x_0</script> around the coarse estimate.  The maximum of these points becomes the final estimate.</p>
<p>The main idea here is that for large values of <script type="math/tex">\kappa</script>, computing the IFFT after zero-padding is computationally infeasible and unnecessary.  Computation time is saved by computing several IDFTs instead at select candidate locations around the coarse estimate.</p>
<p><figure alt="Illustration of algorithm for 1D signal.  Coarse estimate is obtained via IFFT then refined by zero-padding and IDFT. \kappa = 3"><img src="dft_1_step.png" /><figcaption>Illustration of algorithm for 1D signal.  Coarse estimate is obtained via IFFT then refined by zero-padding and IDFT. \kappa = 3</figcaption></figure></p>
<h4 id="method-3-multi-step-idft">Method 3 - Multi Step IDFT</h4>
<p>This method is same as above, but multiple stages of zero-padding and IDFT are used to obtain even finer estimates.</p>
<p><figure alt="Illustration of algorithm for 1D signal.  Identical to above, but 2 stages of zero-padding and IDFT. \kappa = 3"><img src="dft_2_step.png" /><figcaption>Illustration of algorithm for 1D signal.  Identical to above, but 2 stages of zero-padding and IDFT. \kappa = 3</figcaption></figure></p>
<h4 id="conclusion">Conclusion</h4>
<p>This paper seems to be popular because of the simplicity of methods 2 and 3.  However, selection of algorithm parameters <script type="math/tex">\kappa</script>, number of IDFT stages, and number of IDFT points are not theoretically justified and seem to be chosen by trial and error by the authors.</p>
<h1 id="paper-review-extension-of-phase-correlation-to-subpixel-registration">Paper Review - Extension of Phase Correlation to Subpixel Registration</h1>
<p>This is another popular subpixel registration method based on phase correlation.  I like this paper a bit more than the last in that there are no algorithm hyperparameters to choose.  The authors also give special statistical treatment to the error introduced when the circular-shift assumption is dropped (i.e. images are not repeated on a grid).</p>
<h4 id="main-idea">Main Idea</h4>
<p>The fundamental assumption of this paper is that a subpixel shift of an image is actually an integer shift of a higher resolution image that has been subsequently downsampled.</p>
<p>The paper then goes on to show that while phase-correlating the high resolution images results in a dirac delta corresponding to the image offset (a well known result), phase-correlation of the downsampled images yields a sinc function centered at the image offset.</p>
<p>i.e.</p>
<p><code>math
\text{PC}_{HR}(x) = \text{IDFT}(\text{CPSD}_{HR}) = \delta(x - x_0) \\
\text{PC}_{LR}(x) = \text{IDFT}(\text{CPSD}_{LR}) = \frac{\sin(\pi(Mx + x_0))}{\pi(Mx + x_0)}</code></p>
<p>where <script type="math/tex">PC_{HR}</script> and <script type="math/tex">PC_{LR}</script> are the high-resolution and downsampled phase-correlation results, respectively.  This is illustrated below.</p>
<p><figure alt="Original/shifted 1D Images and the phase correlation result. High resolution grid."><img src="extension_overview_1.png" /><figcaption>Original/shifted 1D Images and the phase correlation result. High resolution grid.</figcaption></figure>
<figure alt="Original/shifted 1D Images and the phase correlation result. Downsampled.  Phase-correlation results in a sinc kernel."><img src="extension_overview_2.png" /><figcaption>Original/shifted 1D Images and the phase correlation result. Downsampled.  Phase-correlation results in a sinc kernel.</figcaption></figure></p>
<h4 id="solving-for-the-subpixel-offset">Solving for the subpixel offset</h4>
<p>We can analytically solve for the subpixel offset by choosing two points <script type="math/tex">c_0</script> and <script type="math/tex">c_1</script> from the phase-correlation result and applying the <script type="math/tex">PC_{LR}</script> equation.</p>
<p><code>math
\frac{\sin(\pi x_0)}{\pi x_0} = c_0 \text{ and } \frac{\sin(\pi (M + x_0))}{\pi (M + x_0) = c_1} \Rightarrow \frac{x_0}{M} = \frac{c_1}{c_0 - c_1}</code></p>
<p>A good choice for <script type="math/tex">c_0</script> and <script type="math/tex">c_1</script> are the highest energy points of the phase-correlation result, shown below.</p>
<p><img alt="" src="extension_overview_3.png" /></p>
<h4 id="conclusion_1">Conclusion</h4>
<p>This paper presents a computationally simple approach to subpixel registration which I like better than the more ad-hoc solution presented in Guizar-Sicairos, Thurman, Fienup 2008.  Additionally, the paper analyzes the error introduced from edge effects when the circular-shift assumption is dropped, which I have left out of this report.</p>
<p>One potential area for improvement might be to use more points than just <script type="math/tex">c_0</script> and <script type="math/tex">c_0</script>.  Solving the over-constrained system by using all points from <script type="math/tex">PC_{LR}</script> should give better noise immunity at the expense of increased computation time.</p>
<h1 id="pronys-method-idea">Prony's Method Idea</h1>
<p>Both of the above methods assume that the shifted image <script type="math/tex">g</script> was shifted by <script type="math/tex">(x_0^{\ast}, y_0^*)</script> on a high-resolution grid and then subsequently downsampled.  They both only estimate the position of the peak of the CPSD up to the resolution of this grid.  However, there are spectral estimation techniques such as MUSIC, ESPRIT and Prony's method which make no such assumption and can potentially recover the peak location to infinite precision (assuming no noise).  I haven't yet seen this approach in any papers, although Liao, Fannjiang 2014 has a similar idea for another domain (direction of arrival estimation).</p>
<p>There are a number of variations of Prony's method, but I chose the one presented in ECE551.  i.e. find an annihilating filter and compute its roots.</p>
<h4 id="overview">Overview</h4>
<p>Prony's method is capable of recovering a signal of the form</p>
<p><code>math
x(t) = \sum_{k=0}^{K-1} e^{j 2 \pi \omega_k t}</code></p>
<p>exactly given a finite number of samples.</p>
<p>By solving the following system for the FIR filter <script type="math/tex">h</script>
</p>
<p><code>math
\begin{bmatrix}
x[0] &amp; \dots &amp; x[K] \\ &amp; \vdots &amp; \\ x[N - K - 1] &amp; \dots &amp; x[N - 1]
\end{bmatrix}
\begin{bmatrix}h[K] \\ \vdots \\ h[0] \end{bmatrix} =
\begin{bmatrix} 0 \\ \vdots \\ 0 \end{bmatrix}</code></p>
<p>then solving for the roots of the polynomial formed by <script type="math/tex">h</script>, we can find the exact <script type="math/tex">\omega_k</script>s that form <script type="math/tex">x</script>.</p>
<h4 id="preliminary-tests">Preliminary Tests</h4>
<p>Below are some simple tests of using Prony's method to recover offset of two 1D signals from phase-correlation.  The conclusion is that Prony's method fails to recovery the offset in the presence of large noise or when the circular-shift assumption is dropped.  I hope to address these issues this week.</p>
<p><figure alt="1D Prony's method test for 100 pixel circular shift."><img src="prony_1d_circular.png" /><figcaption>1D Prony's method test for 100 pixel circular shift.</figcaption></figure>
<figure alt="1D Prony's method test for 100 pixel circular shift with 10dB noise."><img src="prony_1d_circular_noise.png" /><figcaption>1D Prony's method test for 100 pixel circular shift with 10dB noise.</figcaption></figure>
<figure alt="1D Prony's method test for 100 pixel linear shift."><img src="prony_1d_linear.png" /><figcaption>1D Prony's method test for 100 pixel linear shift.</figcaption></figure></p>
<h1 id="other-papers">Other Papers</h1>
<ul>
<li><a href="https://ieeexplore.ieee.org/document/1323100">Fundamental Performance Limits in Image Registration</a> - 2004<ul>
<li>Establishes some theoretical bounds on image-registration accuracy.  No specific treatment of super resolution</li>
</ul>
</li>
<li><a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=1457117">A Prony Method for Noisy Data</a> - Kumaresan, Tufts, Scharf 1983<ul>
<li>Potential improvement of results in preliminary tests</li>
</ul>
</li>
<li><a href="https://arxiv.org/pdf/1404.1484">MUSIC for Single-Snapshot Spectral Estimation: Stability and Super-resolution</a> - Liao, Fannjiang 2014<ul>
<li>This is paper is similar to my Prony's method idea in that they apply sparse spectral estimation techniques to phase-correlation.  However, they use MUSIC instead of Prony's method and their problem is related to direction estimation rather than image registration.</li>
</ul>
</li>
</ul>
<h1 id="plans">Plans</h1>
<ul>
<li>implement Kumaresan, Tufts, Scharf 1983 paper</li>
<li>investigate effects of dropping circular-shift assumption on the CPSD (see section in Foroosh paper)</li>
<li>review Liao, Fannjiang 2014 paper</li>
</ul>
  </article>
</main>
<footer>
    <p>SINE UIUC</p>
</footer>
</body>
</html>